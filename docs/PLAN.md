# PLAN.md - 프로젝트 구현 계획 및 로드맵

## 프로젝트 개요

**프로젝트명:** 사내 규정 RAG 챗봇 시스템
**목표:** 사내 문서(인사규정, 매뉴얼 등)를 검색하고 정확한 답변을 제공하는 RAG 기반 챗봇 구축
**핵심 가치:** 정확성, 속도, 신뢰성, 보안

**참고 문서:**
- @PRD.md - 제품 요구사항, 기능 명세, 사용자 페르소나
- @LLD.md - 시스템 아키텍처, API 설계, 구현 상세

---

## 전체 로드맵

### M1: P0 핵심 기능 (현재 진행 중)
**기간:** 현재 → +10주
**목표:** UX/UI 개선 및 핵심 파이프라인 강화

### M2: P1 고급 기능
**기간:** M1 완료 후 → +3주
**목표:** 성능 최적화 및 운영 도구

### M3: P2 운영·배포
**기간:** M2 완료 후 → +2주
**목표:** 프로덕션 배포 준비 완료

**총 예상 기간:** 15주

---

## M1: P0 체크리스트

### ✅ 완료된 항목
- [x] 기본 RAG 파이프라인 (문서 업로드, 파싱, 청킹, 임베딩, 검색, 생성)
- [x] JWT 인증 및 사용자 관리
- [x] 기본 UI (채팅, 업로드, 설정, 관리자 페이지)
- [x] 피드백 시스템 (청크 단위 긍정/부정)
- [x] 성능 모니터링 (test/performance-logging 브랜치)

---

### 🔴 P0-1: 마크다운 출력 + 스트리밍 + 페르소나 (1주)

**담당:** 백엔드 + 프론트엔드
**우선순위:** 최우선 🔴

#### 백엔드 (3일)
- [x] OpenAI 스트리밍 모드 활성화 (`generator.py`)
- [x] WebSocket 프로토콜 확장 (토큰 이벤트)
- [x] 챗봇 페르소나 시스템 프롬프트 적용
  - 페르소나: "사내 규정 안내 전문가 (Knowledge Navigator)"
  - 응답 원칙 5가지 적용 (근거 기반, 친절함, 조항 명시 등)
  - 마크다운 출력 가이드 적용

#### 프론트엔드 (2일)
- [x] react-markdown 설치 및 렌더링 구현
- [x] 토큰 단위 타이핑 효과
- [x] XSS 방지 (react-markdown 내장)
- [x] 조항 커스텀 하이라이트 (`제\d+조`)

#### AC (Acceptance Criteria)
- [x] 첫 토큰 ≤2초
- [x] 마크다운 렌더링 100%
- [x] XSS 테스트 통과
- [x] 타이핑 효과 60fps
- [x] 페르소나 일관성 ≥95%

**참고:**
- 페르소나 상세 설계 → @LLD.md 섹션 4.1
- 시스템 프롬프트 예시 → @LLD.md 섹션 4.1

---

### 🔴 P0-2: 표/그림 인식 파이프라인 (2주)

**담당:** 백엔드
**우선순위:** 최우선 🔴

#### 작업 항목
- [x] PyMuPDF로 이미지 추출 (3일)
- [x] OpenAI Vision API 표 변환 (4일)
- [x] 그림 설명 생성 (3일)
- [x] 청킹 통합 (2일)

#### AC
- [ ] 표 인식률 ≥85% (테스트 필요)
- [ ] 표 기반 질의 정답률 향상 (테스트 필요)
- [ ] 그림 설명 포함된 답변 생성 (테스트 필요)

**참고:** 구현 상세 → @LLD.md 섹션 4.2

**구현 완료 내역:**
- `backend/app/ingest/parsers/image_extractor.py` - PyMuPDF 이미지 추출
- `backend/app/ingest/parsers/vision_processor.py` - Vision API 처리
- `backend/app/models/schemas.py` - Chunk 스키마 확장
- `backend/app/ingest/pipeline.py` - 파이프라인 통합

**현재 상태 및 추후 개선 필요:**
- ✅ 기본 파이프라인 구현 완료
- ⚠️ 성능 이슈: Vision API 응답 시간 및 인식 정확도 개선 필요
- 📋 추후 작업 (P1-2):
  - Vision API 프롬프트 최적화
  - 표/그림 인식률 벤치마크 테스트
  - 저품질 이미지 필터링 로직 추가
  - 배치 처리 최적화

---

### 🔴 P0-3: FAQ 자동 축적 시스템 (1.5주)

**담당:** 백엔드 + 프론트엔드
**우선순위:** 최우선 🔴

#### 백엔드 (5일)
- [x] 질문 로그 저장 (`data/queries.jsonl`)
- [x] DBSCAN 클러스터링
- [x] Top-N FAQ 추출 API (`GET /api/faq`)
- [x] Redis 캐싱 (TTL 7일)
- [x] 자동 갱신 스케줄러

#### 프론트엔드 (2일)
- [x] FAQ 카드 컴포넌트
- [x] 채팅 페이지 상단 노출
- [x] 클릭 시 자동 입력

#### AC
- [x] 100개 이상 질문 수집 시 FAQ 생성
- [x] FAQ 클릭 → 즉시 입력창에 자동 입력
- [x] 7일마다 자동 갱신 (스케줄러)

**참고:** 구현 상세 → @LLD.md 섹션 4.3

**구현 완료 내역:**
- `backend/app/db/models.py` - QueryLog 테이블 모델 추가
- `backend/app/services/faq.py` - FAQ 생성 및 클러스터링 (DB 기반)
- `backend/app/services/redis_client.py` - Redis 캐싱
- `backend/app/services/scheduler.py` - APScheduler 스케줄러
- `backend/app/router/faq.py` - FAQ API 엔드포인트
- `backend/app/router/chat.py` - 질문 로깅 통합 (DB 저장)
- `backend/scripts/init_query_logs.py` - QueryLog 테이블 초기화 스크립트
- `backend/scripts/test_faq_db.py` - FAQ DB 저장 테스트 스크립트
- `frontend/src/components/FAQ/` - FAQ 컴포넌트
- `frontend/src/components/ChatPanel/ChatPanel.jsx` - FAQ 통합

**주요 개선:**
- ✅ JSONL 파일 → DB 저장으로 전환
- ✅ 동시성 문제 해결 (DB 트랜잭션)
- ✅ 빠른 기간별 쿼리 (인덱스)
- ✅ 사용자별 질문 이력 추적 가능 (user_id)
- ✅ 임베딩 온디맨드 생성 (DB 용량 절약)

**테스트 방법:**
```bash
# 1. QueryLog 테이블 생성
cd backend
python scripts/init_query_logs.py

# 2. FAQ DB 저장 테스트
python scripts/test_faq_db.py

# 3. 서버 실행 후 채팅으로 질문 수집
uvicorn app.main:app --reload
```

---

### 🔴 P0-4: 문서 목록·검색 페이지 + 챗봇 사서 (2주)

**담당:** 프론트엔드 + 백엔드
**우선순위:** 최우선 🔴

#### 백엔드 (4일)
- [ ] 문서 검색 API (`GET /api/docs/search`)
- [ ] 필터 지원 (연도, 분류, 태그, 업로더, 키워드)
- [ ] 문서 요약 생성
- [ ] 문서 통계 API
- [ ] 검색 결과 캐싱

#### 프론트엔드 (6일)
- [ ] 문서 브라우저 페이지
- [ ] 필터 사이드바
- [ ] 카드/테이블 뷰 전환
- [ ] 문서 카드 컴포넌트
- [ ] **챗봇 사서 기능** (문서 기반 질문)

#### AC
- [ ] 1초 내 리스트 표출
- [ ] 필터 정확도 100%
- [ ] PDF 미리보기/다운로드
- [ ] 챗봇 사서 정확도 ≥90%

**참고:** API 설계 → @LLD.md 섹션 3.2

---

### 🟡 P0-5: 오케스트레이터 - Intent 라우팅 (1.5주)

**담당:** 백엔드
**우선순위:** 중요 🟡

#### 작업 항목
- [ ] Intent 분류기 구현 (3일)
- [ ] 문서 검색 경로 (2일)
- [ ] RAG 경로 강화 (2일)
- [ ] 라우터 통합 (1일)

#### AC
- [ ] 의도 판별 정확도 ≥95%
- [ ] doc_request: 문서 리스트 반환 100%
- [ ] info_request: 모든 답변에 sources 포함

**참고:** 플로우차트 → @LLD.md 섹션 4.4

---

### 🟡 P0-6: 사내 메일 인증 시스템 (1주)

**담당:** 백엔드 + 프론트엔드
**우선순위:** 중요 🟡

#### 백엔드 (4일)
- [ ] 도메인 화이트리스트 강화
- [ ] OTP 인증 플로우 (`POST /api/auth/email-signup`, `/email-verify`)
- [ ] SMTP 설정
- [ ] 업로드 권한 검증 강화
- [ ] 감사 로그

#### 프론트엔드 (2일)
- [ ] 이메일 인증 페이지
- [ ] OTP 입력 UI

#### AC
- [ ] 비사내 계정 100% 차단
- [ ] OTP 10분 TTL 동작
- [ ] 감사 로그 기록

**참고:** 인증 플로우 → @LLD.md 섹션 6.1

---

### 🟡 P0-7: API 키 라운드로빈 + 재시도 (1주)

**담당:** 백엔드
**우선순위:** 중요 🟡

#### 작업 항목
- [ ] API 키 풀 관리 (3일)
- [ ] 재시도 로직 (2일)
- [ ] 큐잉 시스템 (2일)

#### AC
- [ ] API 키 자동 순환
- [ ] 429 에러 자동 재시도
- [ ] 부하 테스트 실패율 <0.5%
- [ ] 사용량 모니터링

**참고:** 구현 상세 → @LLD.md 섹션 7.3, 7.4

---

## M2: P1 체크리스트

### P1-1: 성능 최적화 - 캐싱 전략 (1주)
- [ ] L1: 임베딩 캐시
- [ ] L2: 검색 결과 캐시
- [ ] L3: 메타데이터 캐시
- [ ] 워밍업 스크립트

**AC:** p50 ≤15s, p90 ≤22s, 캐시 적중률 >60%

---

### P1-2: 인입 파이프라인 강화 (1주)
- [ ] DOCX → Markdown 개선
- [ ] 섹션/조항/용어 추출
- [ ] 마스터 인덱스 생성
- [ ] 메타데이터 강화

**AC:** 신규 문서 5분 내 반영, 인덱스 미스율 <5%

---

### P1-3: 감사 로그 & 모니터링 (1주)
- [ ] 통합 로그 스키마
- [ ] 로그 대시보드
- [ ] 주간 리포트 자동 생성

**AC:** 모든 요청 트레이스 가능, 주간 리포트 산출

---

### P1-4: 출력 일관성 & 근거 강제 (3일)
- [ ] JSON 스키마 검증
- [ ] 시스템 프롬프트 강화
- [ ] 근거 누락 시 재시도

**AC:** JSON 유효성 100%, 모든 답변에 최소 1개 근거

---

## M3: P2 체크리스트

### P2-1: 오타 교정 & 제안형 응답 (1주)
- [ ] 편집 거리 기반 교정
- [ ] 도메인 사전 구축
- [ ] 교정 후보 제시

**AC:** 오타 30케이스 정정 ≥90%

---

### P2-2: UX 경량화 & 모바일 최적화 (1주)
- [ ] 스켈레톤 로딩
- [ ] 근거 접기/펼치기
- [ ] 모바일 반응형 개선
- [ ] 폰트/레이아웃 정리

**AC:** 사용성 테스트 >80%, 모바일 UI 검증

---

### P3-1: 관리자 페이지 강화 (1주)
- [ ] 재인덱스 트리거 UI
- [ ] 캐시 플러시 버튼
- [ ] API 키 상태 모니터링
- [ ] FAQ 고정/숨김 관리

**AC:** UI만으로 운영 작업 가능

---

## 우선순위 요약

### 🔴 최우선 (즉시 착수)
1. P0-1: 마크다운 + 스트리밍 + 페르소나 (1주)
2. P0-2: 표/그림 인식 (2주) - P0-1과 병행 가능
3. P0-3: FAQ 시스템 (1.5주)

### 🟡 중요 (2주 내 착수)
4. P0-4: 문서 목록 + 챗봇 사서 (2주)
5. P0-5: 오케스트레이터 (1.5주)
6. P0-6: 이메일 인증 (1주)
7. P0-7: 라운드로빈 (1주)

### 🟢 보조 (M1 완료 후)
- P1-1~4: 성능, 파이프라인, 로깅, 검증
- P2-1~2: 오타 교정, UX 개선
- P3-1: 관리자 페이지

---

## 일정 요약

| 마일스톤 | 기간 | 주요 항목 | 완료 기준 |
|---------|------|----------|-----------|
| **M1** | 10주 | P0-1~7 | 모든 AC 통과, 성능 목표 달성 |
| **M2** | 3주 | P1-1~4 | 성능, 로깅, 검증 |
| **M3** | 2주 | P2-1~2, P3-1 | UX, 관리 UI |
| **총계** | **15주** | - | 프로덕션 배포 준비 완료 |

---

## 위험 관리

### 주요 위험 요소 및 완화 전략

1. **OpenAI Vision API 비용 증가** (P0-2)
   - 확률: 높음 | 영향: 예산 초과
   - 완화: 표/그림만 Vision API 사용

2. **스트리밍 렌더링 성능 저하** (P0-1)
   - 확률: 중간 | 영향: UI 버벅임
   - 완화: 디바운싱, requestAnimationFrame

3. **FAQ 클러스터링 정확도** (P0-3)
   - 확률: 중간 | 영향: 무의미한 FAQ
   - 완화: 수동 검증 단계, 임계값 튜닝

4. **이메일 OTP 전송 실패** (P0-6)
   - 확률: 낮음 | 영향: 회원가입 불가
   - 완화: 재전송 버튼, SMTP 백업

5. **라운드로빈 키 소진** (P0-7)
   - 확률: 낮음 | 영향: 서비스 중단
   - 완화: 사용량 모니터링, 알림

---

## 릴리즈 체크리스트

### M1 릴리즈 (코어 기능)
- [ ] 모든 P0 항목 AC 통과
- [ ] 성능 목표 달성 (p50 ≤15s, p90 ≤22s)
- [ ] 보안 검토 완료 (OWASP Top 10)
- [ ] 부하 테스트 (동시 100 요청)
- [ ] 감사 로그 검증
- [ ] 문서화 (API 문서, 운영 매뉴얼)
- [ ] 사용자 교육 자료

### M2 릴리즈 (고도화)
- [ ] 정확도 벤치마크
- [ ] FAQ 시스템 검증
- [ ] 사용성 테스트 만족도 >80%
- [ ] 모바일 UI 검증

### M3 릴리즈 (운영)
- [ ] CI/CD 파이프라인 검증
- [ ] 관리자 페이지 기능 검증
- [ ] 롤백 시나리오 테스트
- [ ] 프로덕션 모니터링 대시보드

---

## 다음 단계

### 즉시 착수 (이번 주)
1. **P0-1: 마크다운+스트리밍+페르소나** 🔴
   - 백엔드: `generator.py` 스트리밍 모드
   - 프론트엔드: react-markdown 설치

### 병행 가능 (다음 주)
2. **P0-2: 표/그림 인식** 🔴
   - PyMuPDF 이미지 추출 테스트
   - Vision API 샘플 호출

### 1주 후 착수
3. **P0-3: FAQ 시스템** 🔴
   - 질문 로그 저장 구조 설계
   - 클러스터링 알고리즘 선정

---

## 주간 점검 사항
- [ ] P0-1 완료 여부 (타이핑 효과 동작)
- [ ] P0-2 이미지 추출 성공률
- [ ] 성능 모니터링 브랜치 머지
- [ ] GitHub 진행상황 커밋

---

**참고:**
- 기능 상세 요구사항 → @PRD.md
- 구현 상세 설계 → @LLD.md
- 개발 명령어 및 아키텍처 → @CLAUDE.md

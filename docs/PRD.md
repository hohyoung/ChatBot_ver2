# PRD - 제품 요구사항 명세서
## Product Requirements Document

**제품명:** 사내 규정 RAG 챗봇 시스템
**버전:** 1.0
**작성일:** 2025-01-21
**담당자:** 개발팀

---

## 1. 문제 정의

### 1.1 현재 상황
- 사내 규정 문서(인사규정, 복리후생, 업무 매뉴얼 등)가 다양한 형식(PDF, DOCX)으로 분산 저장
- 직원들이 필요한 정보를 찾기 위해 여러 문서를 직접 열어 검색해야 함
- 규정 해석의 일관성 부족 (같은 질문에 대해 서로 다른 답변)
- HR/총무 팀의 반복적인 문의 응대로 인한 업무 부담

### 1.2 해결하고자 하는 문제
1. **정보 접근성:** 규정 정보를 빠르고 쉽게 찾을 수 없음
2. **정확성:** 해석의 일관성이 보장되지 않음
3. **효율성:** 반복 질문 응대에 소요되는 시간 낭비
4. **신뢰성:** 근거 없는 답변으로 인한 불확실성

### 1.3 제안하는 솔루션
**RAG(Retrieval-Augmented Generation) 기반 챗봇**으로 사내 규정 문서를 검색하고, 근거와 함께 정확한 답변을 제공하는 시스템

---

## 2. 제품 비전 및 목표

### 2.1 비전
"모든 직원이 언제 어디서나 사내 규정을 정확하고 빠르게 이해할 수 있는 지식 플랫폼"

### 2.2 목표
- **정확도:** 규정 관련 질의 응답 정확도 ≥90%
- **속도:** 평균 응답 시간 ≤15초, 90% 응답 시간 ≤22초
- **채택률:** 월간 활성 사용자(MAU) ≥70% (전체 직원 기준)
- **만족도:** 사용자 만족도 ≥4.0/5.0
- **효율성:** HR/총무 팀 반복 문의 응대 시간 50% 감축

---

## 3. 핵심 사용자 및 페르소나

### 3.1 주요 사용자 그룹

#### 페르소나 1: 일반 직원 (Primary User)
- **이름:** 김민준 (입사 2년차, 마케팅팀)
- **니즈:**
  - "연차는 몇 일이지?", "경조사 휴가는 어떻게 신청하지?" 같은 즉각적인 질문 해결
  - 복잡한 문서를 읽지 않고 간단한 답변만 원함
  - 모바일에서도 쉽게 접근
- **페인 포인트:**
  - 규정집 PDF는 너무 길고 어디서 찾아야 할지 모름
  - 담당자에게 물어보기 부담스러움
  - 잘못 이해해서 실수할까 불안함

#### 페르소나 2: HR/총무 담당자 (Secondary User)
- **이름:** 박지영 (HR팀 대리)
- **니즈:**
  - 반복 질문 자동 응대로 업무 효율 향상
  - 문서 업데이트 시 빠른 반영
  - 잘못된 답변 모니터링 및 개선
- **페인 포인트:**
  - 같은 질문을 하루에 10번씩 받음
  - 규정 개정 시 모든 직원에게 공지하기 어려움
  - 챗봇이 틀린 정보를 주면 책임 문제

#### 페르소나 3: 관리자 (Admin)
- **이름:** 최진수 (IT팀 과장)
- **니즈:**
  - 시스템 안정성 모니터링
  - 문서 업로드/삭제 권한 관리
  - 사용 현황 및 성능 지표 확인
- **페인 포인트:**
  - 외부 문서 유입 차단 필요
  - 시스템 장애 시 빠른 대응
  - 비용 관리 (OpenAI API 사용량)

---

## 4. 핵심 기능 요구사항 (재우선순위화)

### 4.1 P0 (최우선 기능 - UX/파이프라인 개선)

#### F1. 마크다운 출력 + 스트리밍 응답 + 챗봇 페르소나 🔴 NEW
- **설명:** 챗봇 답변을 마크다운 형식으로 출력하고 토큰 단위 스트리밍 제공, 일관된 페르소나 적용
- **요구사항:**
  - OpenAI 스트리밍 모드 (stream=True)
  - WebSocket 토큰 이벤트 전송
  - 마크다운 렌더링 (헤딩, 볼드, 리스트, 코드, 표, 인용)
  - 타이핑 효과 (부드러운 토큰 렌더링)
  - XSS 방지 (DOMPurify)
  - **챗봇 페르소나:**
    - 정체성: "사내 규정 안내 전문가 (Knowledge Navigator)"
    - 톤: 전문적이면서도 친근한 어조 (격식 있는 구어체)
    - 응답 원칙: 근거 기반, 친절함, 조항 명시, 표 활용, 불확실성 처리
    - 구조화된 응답 형식 (핵심 답변 → 상세 설명 → 관련 규정 → 출처)
- **AC:**
  - [ ] 첫 토큰 ≤2초
  - [ ] 마크다운 렌더링 100% (일반 서식)
  - [ ] XSS 테스트 통과
  - [ ] 타이핑 효과 60fps
  - [ ] 페르소나 일관성 ≥95% (100개 샘플 답변)

#### F2. 표/그림 인식 파이프라인 🔴 NEW
- **설명:** PDF 내 표와 그림을 텍스트로 변환하여 청킹
- **요구사항:**
  - PyMuPDF로 이미지 추출
  - OpenAI Vision API로 표 → 마크다운 변환
  - 그림 설명 생성 (OCR + Vision)
  - 메타데이터 추가 (table_schema, figure_id, image_url)
- **AC:**
  - [ ] 표 인식률 ≥85% (샘플 20개)
  - [ ] 표 기반 질의 정답률 향상 (before/after)
  - [ ] 그림 설명 포함 답변 생성

#### F3. FAQ 자동 축적 시스템 🔴 NEW
- **설명:** 자주 묻는 질문을 자동으로 수집하고 노출
- **요구사항:**
  - 질문 로그 저장 (임베딩 포함)
  - sklearn DBSCAN 클러스터링
  - Top-10 FAQ 추출 API
  - 7일 자동 갱신
  - 채팅 페이지 상단 FAQ 카드 3개 노출
- **AC:**
  - [ ] 질문 100개 이상 수집 시 FAQ 자동 생성
  - [ ] FAQ 클릭 → 3초 내 응답
  - [ ] 7일마다 자동 갱신

#### F4. 문서 목록·검색 페이지 + 챗봇 사서 🔴 NEW
- **설명:** 업로드된 문서 검색/열람 및 문서 기반 질문 기능
- **요구사항:**
  - 검색 API (키워드, 태그, 연도, 카테고리, 업로더 필터)
  - 페이지네이션, 정렬
  - 카드/테이블 뷰 전환
  - 문서 요약 생성 (LLM)
  - **챗봇 사서:** "이 문서에 대해 질문하기" 버튼
    - 클릭 시 채팅 페이지로 이동 + 문서 컨텍스트 전달
- **AC:**
  - [ ] 1초 내 리스트 표출 (캐시 적중)
  - [ ] 필터 조합 정확도 100%
  - [ ] 챗봇 사서: 문서 기반 질문 정확도 ≥90%

#### F5. 오케스트레이터 - Intent 라우팅 🟡
- **설명:** 질문 의도 분석하여 적절한 경로로 라우팅
- **요구사항:**
  - doc_request: 문서 리스트 반환
  - info_request: RAG 답변
  - 마스터 인덱스 기반 문서 선별
  - 문단 압축 로직
- **AC:**
  - [ ] 의도 판별 정확도 ≥95%
  - [ ] doc_request: 문서 리스트 반환 100%
  - [ ] info_request: 모든 답변에 sources 포함

#### F6. 사내 메일 인증 시스템 🟡
- **설명:** 이메일 OTP 기반 회원가입
- **요구사항:**
  - 도메인 화이트리스트 (soosan.com, soosan.co.kr)
  - 6자리 OTP 생성 + 이메일 전송
  - Redis 10분 TTL
  - SMTP 설정
- **AC:**
  - [ ] 비사내 계정 회원가입 100% 차단
  - [ ] OTP 10분 TTL 동작
  - [ ] 감사 로그 기록

#### F7. API 키 라운드로빈 + 재시도 🟡
- **설명:** 다중 API 키 순환 사용 및 429 에러 재시도
- **요구사항:**
  - API 키 풀 관리
  - 라운드로빈 로직
  - 지수 백오프 재시도
  - 사용량 모니터링
- **AC:**
  - [ ] API 키 자동 순환
  - [ ] 429 에러 시 자동 재시도 (최대 3회)
  - [ ] 부하(동시 100) 실패율 <0.5%

### 4.2 P1 (보조 기능 - 기존 시스템 개선)

#### F8. 성능 최적화 - 캐싱
- **요구사항:** L1(임베딩), L2(검색), L3(메타데이터) 캐시
- **AC:** p50 ≤15s, p90 ≤22s

#### F9. 인입 파이프라인 강화
- **요구사항:** DOCX→Markdown, 섹션 추출, 마스터 인덱스
- **AC:** 신규 문서 5분 내 반영

#### F10. 감사 로그 & 모니터링
- **요구사항:** JSONL 로그, 대시보드, 주간 리포트
- **AC:** 모든 요청 트레이스 가능

### 4.3 P2 (추가 기능)
- **설명:** 사용자가 직접 문서를 검색하고 미리보기/다운로드
- **요구사항:**
  - 필터: 연도, 분류, 태그, 업로더, 키워드
  - 뷰 옵션: 카드 뷰, 테이블 뷰
  - 미리보기: 메타데이터, 요약, 첫 페이지
  - 다운로드 버튼
- **AC:**
  - [ ] 1초 내 리스트 표출 (캐시 기준)
  - [ ] 필터 조합 시 정확한 결과
  - [ ] PDF 뷰어 내장 (iframe 또는 PDF.js)

#### F4. 사용자 인증 및 권한 관리
- **설명:** 사내 메일 기반 회원가입 및 등급 관리
- **요구사항:**
  - 도메인 화이트리스트 (`@soosan.com`, `@soosan.co.kr`)
  - JWT 기반 인증
  - 사용자 등급: 일반(3), 파워유저(2), 관리자(1)
  - 업로드 권한은 파워유저 이상
- **AC:**
  - [ ] 비사내 계정 회원가입 100% 차단
  - [ ] 업로드 시 권한 검증
  - [ ] 감사 로그 기록

#### F5. 피드백 시스템
- **설명:** 답변에 대한 긍정/부정 피드백 수집
- **요구사항:**
  - 청크 단위 피드백 (up/down)
  - 피드백 기반 부스트 점수 조정
  - 피드백 히스토리 저장
- **AC:**
  - [ ] 피드백 즉시 반영
  - [ ] 부스트 점수가 다음 검색에 적용

#### F6. 관리자 페이지
- **설명:** 시스템 관리 및 모니터링
- **요구사항:**
  - 전체 문서 목록/삭제
  - 사용자 관리 (등급 변경, 활성화/비활성화)
  - 업로드 작업 상태 모니터링
- **AC:**
  - [ ] 관리자만 접근 가능 (security_level: 1)
  - [ ] 모든 사용자 문서 조회/삭제 가능

### 4.2 P1 (중요 기능)

#### F7. Intent 라우팅 (오케스트레이터)
- **설명:** 질문 의도를 분석하여 적절한 경로로 라우팅
- **요구사항:**
  - `doc_request`: 문서 리스트 반환
  - `info_request`: RAG 답변
  - 마스터 인덱스 기반 상위 3개 문서 선별
- **AC:**
  - [ ] 의도 판별 정확도 ≥95% (100개 샘플)

#### F8. 스트리밍 응답
- **설명:** 답변을 토큰 단위로 실시간 전송
- **요구사항:**
  - OpenAI 스트리밍 모드
  - WebSocket 토큰 이벤트
  - 프론트엔드 타이핑 효과
- **AC:**
  - [ ] 첫 토큰 ≤2초 (캐시 적중 시)

#### F9. 표/그림 인식
- **설명:** PDF 내 표와 그림을 텍스트로 변환
- **요구사항:**
  - OCR 또는 비전 API 활용
  - 마크다운 표 형식 변환
  - 메타데이터 추가 (table_schema, figure_id)
- **AC:**
  - [ ] 표 기반 질의 정답률 유의미 개선

#### F10. FAQ 자동 축적
- **설명:** 자주 묻는 질문을 자동으로 수집하고 노출
- **요구사항:**
  - 질문 로그 클러스터링
  - Top-N FAQ 자동 갱신 (7일 주기)
  - 사이드바에 카드 형태 노출
- **AC:**
  - [ ] FAQ 클릭 시 3초 내 응답

### 4.3 P2 (추가 기능)

#### F11. 오타 교정
- **설명:** 사내 용어 오타 자동 감지 및 교정
- **요구사항:**
  - 편집 거리 기반 교정
  - 도메인 사전 (사내 용어)
- **AC:**
  - [ ] 의도적 오타 30케이스에서 정정 적중 ≥90%

#### F12. 관리자 운영 도구
- **설명:** 코드 수정 없이 시스템 운영
- **요구사항:**
  - 재인덱스 트리거
  - 캐시 플러시
  - API 키 상태 모니터링
  - FAQ 고정/숨김
- **AC:**
  - [ ] UI만으로 주요 운영 작업 수행 가능

---

## 5. 비기능 요구사항 (NFR)

### 5.1 성능
- **응답 시간:**
  - p50 (중앙값): ≤15초
  - p90 (90%): ≤22초
  - 첫 토큰 (스트리밍): ≤2초
- **처리량:**
  - 동시 요청: 100개 이상 처리 가능
  - 초당 요청(RPS): 20 이상
- **문서 처리:**
  - 업로드 후 인덱싱: 5분 이내

### 5.2 가용성
- **목표 가동률:** 99% (월 기준, 약 7시간 다운타임 허용)
- **장애 복구 시간(MTTR):** 1시간 이내
- **백업:** 일 1회 자동 백업 (문서, 사용자 DB, 벡터 DB)

### 5.3 확장성
- **사용자:** 500명까지 확장 가능 (현재 100명 가정)
- **문서:** 10,000개 문서, 100,000 청크까지 지원
- **수평 확장:** 서버 인스턴스 추가로 처리량 증가 가능

### 5.4 보안
- **인증:** JWT 기반, 토큰 만료 시간 3600초
- **권한:** RBAC (Role-Based Access Control)
- **데이터 암호화:**
  - 전송: HTTPS/WSS
  - 저장: 비밀번호 해시 (bcrypt)
- **감사 로그:** 모든 업로드/삭제/관리 작업 기록
- **비사내 계정 차단:** 100% 차단

### 5.5 사용성
- **학습 곡선:** 5분 이내 기본 사용법 숙지
- **모바일 지원:** 반응형 UI (768px 이하)
- **브라우저 지원:** Chrome, Edge, Safari 최신 2개 버전
- **접근성:** WCAG 2.1 Level A 준수 (향후)

### 5.6 유지보수성
- **코드 품질:** ESLint, pytest 통과
- **문서화:** API 문서 자동 생성 (/docs)
- **로깅:** 구조화된 JSON 로그
- **모니터링:** 주요 지표 대시보드

### 5.7 비용
- **OpenAI API:** 월 $500~$1,000
- **인프라:** 월 $300~$500
- **총 예상 비용:** 월 $800~$1,500

---

## 6. 핵심 시나리오

### 6.1 시나리오 1: 일반 직원의 연차 문의 (info_request)
**사용자:** 김민준 (마케팅팀)

1. 김민준이 챗봇에 "입사 2년차 연차는 몇 일인가요?" 질문 입력
2. 시스템이 질문을 태깅 (`hr-policy`, `vacation`)
3. 벡터 검색으로 관련 청크 3~5개 검색
4. LLM이 근거와 함께 답변 생성:
   - **답변:** "입사 2년차의 경우 연차는 15일입니다."
   - **근거:** 인사규정.pdf 3페이지 (chunk_id: doc_abc123_0005)
5. 프론트엔드에 답변 + 출처 표시
6. 김민준이 출처 클릭 → PDF 뷰어에서 해당 페이지 열림
7. 김민준이 긍정 피드백 (👍) 클릭

**기대 결과:**
- 응답 시간: 10초 이내
- 정확한 답변 + 페이지 번호 제공
- 피드백 즉시 반영

### 6.2 시나리오 2: HR 담당자의 규정 문서 업데이트 (doc_request)
**사용자:** 박지영 (HR팀 대리)

1. 박지영이 "2025년 개정 인사규정.pdf" 업로드
2. 시스템이 중복 체크 (해시 기반) → 신규 파일 확인
3. 백그라운드 파이프라인 시작:
   - PDF 파싱 → 청킹 (페이지 정보 보존)
   - 태그 생성 (`hr-policy`, `2025`, `revision`)
   - 임베딩 생성 → ChromaDB 업서트
4. 5분 후 작업 완료, 박지영에게 알림
5. 박지영이 문서 검색 페이지에서 새 문서 확인
6. 테스트 질의: "2025년 육아휴직 규정은?" → 새 문서 기반 답변

**기대 결과:**
- 업로드 후 5분 내 검색 가능
- 중복 파일 자동 스킵
- 정확한 태그 자동 생성

### 6.3 시나리오 3: 관리자의 시스템 모니터링
**사용자:** 최진수 (IT팀 과장)

1. 최진수가 관리자 페이지 접속
2. 대시보드에서 주요 지표 확인:
   - 오늘 질의 수: 87건
   - 평균 응답 시간: 12.3초
   - OpenAI API 사용량: 15,000 토큰 ($0.30)
   - 429 에러: 0건
3. 사용자 목록에서 비활성 계정 확인 → 비활성화
4. 문서 목록에서 오래된 규정 확인 → 삭제
5. 재인덱스 트리거 클릭 → 인덱스 갱신

**기대 결과:**
- 실시간 모니터링 가능
- UI만으로 주요 운영 작업 수행
- 권한 검증 (관리자만 접근)

---

## 7. 성공 지표 (KPI)

### 7.1 정량 지표
| 지표 | 목표 | 측정 방법 |
|-----|------|----------|
| **정확도** | ≥90% | 100개 샘플 질의 정답률 (주간 평가) |
| **응답 시간 (p50)** | ≤15초 | 로그 분석 (7일 이동 평균) |
| **응답 시간 (p90)** | ≤22초 | 로그 분석 (7일 이동 평균) |
| **MAU (월간 활성 사용자)** | ≥70% | 로그인 사용자 수 / 전체 직원 수 |
| **일 평균 질의 수** | ≥200건 | 채팅 로그 집계 |
| **피드백 긍정률** | ≥80% | 긍정 피드백 / 전체 피드백 |
| **시스템 가용률** | ≥99% | 업타임 모니터링 |
| **API 비용** | ≤$1,000/월 | OpenAI 대시보드 |

### 7.2 정성 지표
- **사용자 만족도:** ≥4.0/5.0 (분기별 설문)
- **HR 팀 반복 문의 감소:** 50% 이상 (분기별 측정)
- **오답 신고율:** <5% (전체 답변 대비)

---

## 8. 제외 사항 (Out of Scope)

### 8.1 V1.0에서 제외
- **다국어 지원:** 한국어만 지원 (영어는 V2.0)
- **음성 인터페이스:** 텍스트만 지원
- **Slack/Teams 연동:** 웹 UI만 제공
- **외부 공개:** 사내 전용 (외부 접근 차단)
- **실시간 협업:** 다중 사용자 동시 편집 불필요

### 8.2 향후 고려 사항
- **V2.0:** 영어 지원, Slack 봇 연동
- **V3.0:** 음성 입력/출력, 모바일 앱
- **장기:** 타 부서 규정 확장 (재무, 법무 등)

---

## 9. 의존성 및 제약사항

### 9.1 외부 의존성
- **OpenAI API:** GPT-4o-mini, text-embedding-3-small
- **인프라:** AWS 또는 Azure
- **데이터베이스:** SQLite (개발) / MSSQL (프로덕션)

### 9.2 제약사항
- **법적 제약:** 개인정보 보호법 준수 (사용자 이메일, 로그)
- **기술 제약:** OpenAI API 요금제 한도, 429 에러
- **운영 제약:** 야간 유지보수 시간 (매주 일요일 02:00~04:00)

---

## 10. 릴리즈 계획

### V1.0 (M1: P0 코어)
- **목표 날짜:** 2025년 4월 말
- **주요 기능:** F1~F6
- **배포 범위:** 스테이징 → 파일럿 그룹 (50명) → 전체

### V1.1 (M2: P1 고도화)
- **목표 날짜:** 2025년 5월 말
- **주요 기능:** F7~F10
- **배포 범위:** 전체 직원

### V1.2 (M3: P2 운영)
- **목표 날짜:** 2025년 6월 말
- **주요 기능:** F11~F12
- **배포 범위:** 프로덕션 안정화

---

## 11. 승인 및 서명

| 역할 | 이름 | 서명 | 날짜 |
|-----|------|------|------|
| Product Owner | - | - | - |
| Tech Lead | - | - | - |
| Stakeholder (HR) | - | - | - |
| Stakeholder (IT) | - | - | - |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|----------|--------|
| 1.0 | 2025-01-21 | 초안 작성 | 개발팀 |
